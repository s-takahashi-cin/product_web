<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>注文フォーム</title>
    <link rel="stylesheet" type="text/css" href="/css/orderForm.css" />
  </head>
  <body>
    <div class="header-container">
      <h2>注文者情報入力</h2>
      <form th:action="@{/orderComplete}" method="post">
        <table>
          <tr>
            <td>店舗</td>
            <td>
              <span
                th:text="${user.storeId == 1 ? '渋谷店' : (user.storeId == 2 ? '新宿店' : (user.storeId == 3 ? '池袋店' : '未設定'))}"
              ></span>
              <input type="hidden" name="storeId" th:value="${user.storeId}" />
            </td>
          </tr>
          <tr>
            <td>名前</td>
            <td th:text="${user.lastName}"></td>
            <input type="hidden" name="lastName" th:value="${user.lastName}" />
          </tr>
          <tr>
            <td>注文内容</td>
            <td>
              <div id="cart-items"></div>
              <div id="total-quantity"></div>
              <div id="total-amount"></div>
            </td>
          </tr>
          <input type="hidden" name="quantities" id="quantities" value="" />
          <input type="hidden" name="totalAmount" id="totalAmount" value="" />
          <input type="hidden" name="id" id="id" value="" />
          <input type="hidden" name="name" id="name" value="" />
          <input type="hidden" name="price" id="price" />
        </table>
        <input type="submit" value="注文を確定する" />
      </form>
    </div>
    <div class="back_button">
      <a th:href="@{/home}">戻る</a>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        function displayCart() {
          var cartItemsContainer = document.getElementById("cart-items");
          var totalQuantityElem = document.getElementById("total-quantity");
          var totalAmountElem = document.getElementById("total-amount");

          cartItemsContainer.innerHTML = "";
          var cart = loadCart();
          var table = document.createElement("table");

          // テーブルのヘッダー行を追加
          var headerRow = table.insertRow();
          headerRow.insertCell().textContent = "商品ID";
          headerRow.insertCell().textContent = "商品名";
          headerRow.insertCell().textContent = "価格";
          headerRow.insertCell().textContent = "数量";

          var totalQuantity = 0;
          var totalAmount = 0;

          // カートのアイテムをテーブルに追加
          cart.forEach(function (item) {
            var row = table.insertRow();
            row.insertCell().textContent = item.id; // 修正したフィールド名
            row.insertCell().textContent = item.name; // 修正したフィールド名
            row.insertCell().textContent = formatPrice(item.price); // 修正したフィールド名
            row.insertCell().textContent = item.quantity + "個"; // 修正したフィールド名
            var subtotal = item.price * item.quantity; // 修正したフィールド名
            totalQuantity += item.quantity;
            totalAmount += subtotal;
          });

          // 合計行を追加
          var totalRow = table.insertRow();
          var totalCell = totalRow.insertCell();
          totalCell.colSpan = 4;
          totalCell.textContent = "合計金額";
          totalRow.insertCell().textContent = formatPrice(totalAmount);

          cartItemsContainer.appendChild(table);

          // Hidden フィールドの値を設定
          document.getElementById("quantities").value = cart
            .map((item) => item.quantity)
            .join(",");
          document.getElementById("totalAmount").value = totalAmount;
          document.getElementById("id").value = cart
            .map((item) => item.id)
            .join(",");
          document.getElementById("name").value = cart
            .map((item) => item.name)
            .join(",");
          document.getElementById("price").value = cart
            .map((item) => item.price)
            .join(",");
        }

        function loadCart() {
          var cart = localStorage.getItem("cart");
          if (cart) {
            try {
              var parsedCart = JSON.parse(cart);
              console.log("カートの内容を表示します:", parsedCart);
              parsedCart.forEach((item) => {
                if (
                  typeof item.productPrice !== "number" ||
                  isNaN(item.price)
                ) {
                  console.error("無効な価格:", item.price);
                  item.productPrice = 0;
                }
              });
              return parsedCart;
            } catch (e) {
              console.error("カートの内容の解析エラー:", e);
              return [];
            }
          } else {
            console.log("カートが空です");
            return [];
          }
        }

        function clearCart() {
          localStorage.removeItem("cart");
        }

        function formatPrice(price) {
          return price.toLocaleString("ja-JP", {
            style: "currency",
            currency: "JPY",
          });
        }

        displayCart();
      });
    </script>
  </body>
</html>
